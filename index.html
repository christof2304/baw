<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAW Cesium Viewer mit JSON Kommentarfunktion</title>

  <!-- Performance Optimizations -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://api.cesium.com" crossorigin>
  <link rel="dns-prefetch" href="https://assets.cesium.com">

  <!-- Preload critical resources -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/cesium@1.132/Build/Cesium/Cesium.js" as="script">
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/cesium@1.132/Build/Cesium/Widgets/widgets.css" as="style">

  <!-- Load Cesium -->
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.132/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />

  <!-- Critical CSS (minimal fÃ¼r Initialisierung) -->
  <style>
    #appContainer, #cesiumContainer, html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #4FC3F7; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .is-hidden { display: none !important; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9998; }
  </style>

  <!-- Load custom styles -->
  <link rel="stylesheet" href="baw.css">
</head>
<body>
  <div id="appContainer">
    <div id="cesiumContainer"></div>
    <div id="uiContainer">
      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div id="loadingText">Cesium wird initialisiert...</div>
      </div>

      <!-- Toast Container -->
      <div id="toastContainer" class="toast-container"></div>

      <!-- Comment Mode Indicator -->
      <div id="commentModeIndicator" class="comment-mode-indicator is-hidden">
        ğŸ’¬ Klicken Sie auf die Karte, um einen Kommentar hinzuzufÃ¼gen
      </div>

      <!-- Main UI Panel -->
      <div id="mainUI" class="main-ui">
        <div class="ui-header">
          <span>ğŸ— CESIUM | BAW Viewer</span>
        </div>
        <div class="ui-content">
          <!-- Data Management -->
          <div class="data-management">
            <h4>ğŸ“‚ Kommentar-Daten</h4>
            <div class="form-group">
              <label class="form-label" for="userName">Ihr Name</label>
              <input type="text" id="userName" class="form-input" placeholder="Max Mustermann">
            </div>
            <div class="data-actions">
              <button id="exportJSON" class="btn btn-success btn-small">ğŸ“„ JSON Export</button>
              <button id="exportCSV" class="btn btn-success btn-small">ğŸ“Š CSV Export</button>
              <button id="importData" class="btn btn-primary btn-small">ğŸ“¥ Import</button>
              <button id="clearData" class="btn btn-danger btn-small">ğŸ—‘ï¸ LÃ¶schen</button>
            </div>
            <input type="file" id="fileInput" class="hidden-file-input" accept=".json,.csv">
            <div id="dataStatus" class="data-status">Bereit fÃ¼r Kommentare</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="sceneSelect">Modell auswÃ¤hlen</label>
            <select id="sceneSelect" class="form-select">
              <option value="">â€“ Bitte auswÃ¤hlen â€“</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="imagerySelect">Kartenhintergrund</label>
            <select id="imagerySelect" class="form-select">
              <option value="ortho">Lokales Orthophoto (hochauflÃ¶send)</option>
              <option value="bing" selected>Bing Aerial (global)</option>
              <option value="osm">OpenStreetMap (global)</option>
            </select>
          </div>

          <!-- Render Quality Control -->
          <div class="form-group">
            <label class="form-label" for="renderQualitySelect">ğŸ® Render-QualitÃ¤t</label>
            <select id="renderQualitySelect" class="form-select">
              <option value="performance">âš¡ Performance (schwache PCs)</option>
              <option value="balanced" selected>âš–ï¸ Ausgeglichen (empfohlen)</option>
              <option value="quality">ğŸ’ QualitÃ¤t (starke PCs)</option>
            </select>
            <div class="render-quality-info">
              <small id="renderQualityDescription" class="render-quality-description">
                Optimiert fÃ¼r gute Balance zwischen QualitÃ¤t und Performance
              </small>
            </div>
          </div>

          <div id="panelToggles" class="checkbox-group is-hidden">
            <div class="form-label">Panels</div>
            <div class="checkbox-item">
              <input type="checkbox" id="toggleCommentsPanel">
              <label for="toggleCommentsPanel">ğŸ’¬ Kommentare</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="toggleMeasurePanel">
              <label for="toggleMeasurePanel">ğŸ“ Messen</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="toggleHiddenFeaturesPanel">
              <label for="toggleHiddenFeaturesPanel">ğŸ‘ï¸ Elemente ausblenden</label>
            </div>
          </div>

          <!-- CityGML Toggle (nur fÃ¼r Lauffen) -->
          <div id="citygmlToggleContainer" class="checkbox-group is-hidden">
            <div class="form-label">3D GebÃ¤ude</div>
            <div class="checkbox-item">
              <input type="checkbox" id="citygmlToggle">
              <label for="citygmlToggle">ğŸ¢ CityGML einblenden</label>
            </div>
          </div>

          <!-- Lauffen Teilmodelle (nur fÃ¼r Lauffen) -->
          <div id="lauffenModelToggles" class="checkbox-group is-hidden">
            <div class="form-label">Teilmodelle</div>
            <div class="checkbox-item">
              <input type="checkbox" id="model3256557" data-asset-id="3256557">
              <label for="model3256557">ğŸš§ Wehranlage</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="model3256547" data-asset-id="3256547">
              <label for="model3256547">ğŸŸ Fischleiter</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="model3256555" data-asset-id="3256555">
              <label for="model3256555">âš™ï¸ AufschÃ¼ttung</label>
            </div>
            <div class="model-toggle-buttons">
              <button id="testLauffenModels" class="btn btn-ghost btn-small">ğŸ”§ Test Toggle</button>
              <button id="showAllLauffen" class="btn btn-success btn-small">ğŸ‘ï¸ Alle zeigen</button>
              <button id="hideAllLauffen" class="btn btn-danger btn-small">ğŸ™ˆ Alle verstecken</button>
            </div>
          </div>

          <!-- Zeltingen Teilmodelle (nur fÃ¼r Zeltingen) -->
          <div id="zeltingenModelToggles" class="checkbox-group is-hidden">
            <div class="form-label">Teilmodelle</div>
            <div class="checkbox-item">
              <input type="checkbox" id="model3251780" data-asset-id="3251780">
              <label for="model3251780">ğŸ—ï¸ BIM Modell</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="model3341583" data-asset-id="3341583">
              <label for="model3341583">â˜ï¸ Punktwolke</label>
            </div>
            <div class="model-toggle-buttons">
              <button id="testZeltingenModels" class="btn btn-ghost btn-small">ğŸ”§ Test Toggle</button>
              <button id="showAllZeltingen" class="btn btn-success btn-small">ğŸ‘ï¸ Alle zeigen</button>
              <button id="hideAllZeltingen" class="btn btn-danger btn-small">ğŸ™ˆ Alle verstecken</button>
            </div>
          </div>

          <!-- Punktwolken-Kontrolle (nur fÃ¼r Zeltingen) -->
          <div id="pointCloudControls" class="checkbox-group is-hidden">
            <div class="form-label">â˜ï¸ Punktwolken-Einstellungen</div>
            <div class="point-cloud-slider-container">
              <label for="pointSizeControl" class="point-cloud-slider-label">
                ğŸ”¸ PunktgrÃ¶ÃŸe: <span id="pointSizeValue">Normal</span>
              </label>
              <input type="range" id="pointSizeControl" class="point-cloud-slider" min="0.1" max="2.0" step="0.1" value="0.5">
              <div class="point-cloud-slider-range">
                <span>Sehr klein</span>
                <span>Sehr groÃŸ</span>
              </div>
            </div>
            <div class="checkbox-item point-cloud-checkbox">
              <input type="checkbox" id="toggleAttenuation" checked>
              <label for="toggleAttenuation">ğŸ“ Distance Attenuation</label>
            </div>
            <div class="point-cloud-debug">
              <button id="debugPointCloud" class="btn btn-ghost btn-small">ğŸ”§ Debug Info</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Info Box -->
      <div id="infoBox" class="info-box is-hidden">
        <div class="info-header">
          <div class="info-title">Objekt Information</div>
          <button id="closeInfoBtn" class="close-btn">Ã—</button>
        </div>
        <div id="infoContent"></div>
        <div class="info-actions">
          <button id="hideFeatureBtn" class="btn btn-warning btn-small">ğŸ‘ï¸â€ğŸ—¨ï¸ Elemente ausblenden</button>
        </div>
      </div>

      <!-- Hidden Features Panel -->
      <div id="hiddenFeaturesPanel" class="hidden-features-panel is-hidden">
        <div class="comments-header">
          <div class="comments-title">ğŸ‘ï¸ Versteckte Features</div>
          <div>
            <button id="toggleHideMode" class="btn btn-primary btn-small">ğŸ¯ Hide-Modus</button>
            <button id="showAllHidden" class="btn btn-success btn-small">ğŸ‘ï¸ Alle zeigen</button>
            <button id="closeHiddenFeaturesBtn" class="btn btn-ghost btn-small">Ã—</button>
          </div>
        </div>
        <div class="comments-content">
          <div class="hidden-features-content">
            <div id="hideModeIndicator" class="hide-mode-indicator is-hidden">
              <span class="hide-mode-indicator-text">ğŸ¯ Hide-Modus aktiv - Klicke auf Element!</span>
            </div>
            <div id="hiddenFeaturesList" class="hidden-features-list">
              <div class="no-hidden-features">
                Keine versteckten Features.<br>
                <small>Nutzen Sie den Hide-Modus oder verstecken Sie Elemente Ã¼ber die Info-Box.</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Measurement Panel -->
      <div id="measurePanel" class="measure-panel is-hidden">
        <div class="comments-header">
          <div class="comments-title">ğŸ“ Mess-Werkzeuge</div>
          <div>
            <button id="clearMeasurements" class="btn btn-ghost btn-small">ğŸ—‘ï¸</button>
            <button id="closeMeasureBtn" class="btn btn-ghost btn-small">Ã—</button>
          </div>
        </div>
        <div class="comments-content">
          <div class="measure-panel-content">
            <div class="form-group">
              <label class="form-label">Mess-Modus auswÃ¤hlen</label>
              <select id="measureModeSelect" class="form-select">
                <option value="">â€“ Inaktiv â€“</option>
                <option value="height">ğŸ“ HÃ¶he Ã¼ber Terrain</option>
                <option value="distance">ğŸ“ Punkt-zu-Punkt Abstand</option>
                <option value="polyline">ğŸ“ Polygon-LÃ¤nge</option>
                <option value="area">ğŸ“Š Polygon-FlÃ¤che</option>
              </select>
            </div>
            <div id="measureInstructions" class="measure-instructions is-hidden">
              <div id="instructionText"></div>
            </div>
            <div id="currentMeasurement" class="measure-current is-hidden">
              <div class="measure-current-title">Aktueller Messwert:</div>
              <div id="measurementValue" class="measure-current-value"></div>
              <div id="measurementDetails" class="measure-current-details"></div>
            </div>
            <div id="measurementHistory" class="measure-history">
              <div id="historyTitle" class="measure-history-title is-hidden">Letzte Messungen:</div>
              <div id="historyList"></div>
            </div>
            <div class="measure-actions">
              <button id="finishMeasurement" class="btn btn-primary btn-small is-hidden">âœ” Beenden</button>
              <button id="cancelMeasurement" class="btn btn-ghost btn-small is-hidden">âœ— Abbrechen</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Comments Panel -->
      <div id="commentsPanel" class="comments-panel is-hidden">
        <div class="comments-header">
          <div class="comments-title">ğŸ’¬ Kommentare</div>
          <div>
            <button id="refreshComments" class="btn btn-ghost btn-small">ğŸ”„</button>
            <button id="toggleCommentMode" class="btn btn-primary btn-small">âœï¸ HinzufÃ¼gen</button>
            <button id="closeCommentsBtn" class="btn btn-ghost btn-small">Ã—</button>
          </div>
        </div>
        <div class="comments-content">
          <div class="comments-list" id="commentsList">
            <div class="no-comments" id="noComments">
              Noch keine Kommentare vorhanden.<br>
              <small>Aktivieren Sie den HinzufÃ¼gen-Modus und klicken Sie auf die Karte.</small>
            </div>
          </div>
          <div class="add-comment-section">
            <div class="comment-mode" id="commentModeStatus">
              <span class="comment-mode-icon">ğŸ’¬</span>
              <span id="commentModeText">Kommentar-Modus: Inaktiv</span>
            </div>
            <textarea id="commentInput" class="comment-input" placeholder="Neuen Kommentar eingeben..." disabled></textarea>
            <div class="comment-submit-section">
              <button id="addCommentBtn" class="btn btn-primary" disabled>ğŸ’¬ Kommentar hinzufÃ¼gen</button>
              <button id="cancelCommentBtn" class="btn btn-ghost" disabled>Abbrechen</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Comment Edit Overlay -->
      <div id="commentEditOverlay" class="comment-edit-overlay is-hidden">
        <div class="comment-edit-dialog">
          <div class="comment-edit-title">Kommentar bearbeiten</div>
          <textarea id="commentEditInput" class="comment-edit-input" placeholder="Kommentar bearbeiten..."></textarea>
          <div class="comment-edit-actions">
            <button id="saveCommentBtn" class="btn btn-primary">ğŸ’¾ Speichern</button>
            <button id="cancelEditBtn" class="btn btn-ghost">Abbrechen</button>
          </div>
        </div>
      </div>

      <!-- CSV Export Dialog -->
      <div id="csvExportOverlay" class="csv-export-overlay is-hidden">
        <div class="csv-export-dialog">
          <div class="csv-export-title">ğŸ“Š CSV Export - Vorschau</div>
          <div id="csvPreview" class="csv-preview"></div>
          <div class="csv-actions">
            <button id="downloadCSV" class="btn btn-success">ğŸ’¾ CSV herunterladen</button>
            <button id="copyCSV" class="btn btn-primary">ğŸ“‹ In Zwischenablage</button>
            <button id="cancelCSV" class="btn btn-ghost">Abbrechen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load custom JavaScript -->
  <script src="baw-utils.js"></script>
  <script src="baw-comments.js"></script>
  <script src="baw-core.js"></script>
</body>
</html>
